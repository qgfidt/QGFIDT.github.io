<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æƒ…ä¾£æ—¶å…‰ - é’¥åŒ™æ‰£ä¸“å±çˆ±æƒ…è®°å½•å¹³å°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #ff6b8b;
            --primary-dark: #ff476f;
            --secondary: #8b5cf6;
            --secondary-dark: #7c3aed;
            --bg: #fff5f7;
            --card-bg: #fff9fc;
            --text: #333;
            --text-light: #666;
            --border: #ffd1dc;
            --border-light: #ffe5ec;
            --danger: #ef4444;
        }
        .dark-mode {
            --primary: #ff8fa3;
            --primary-dark: #ff6b8b;
            --secondary: #a78bfa;
            --secondary-dark: #8b5cf6;
            --bg: #1f1f2e;
            --card-bg: #2d2d44;
            --text: #f0f0f0;
            --text-light: #b0b0c0;
            --border: #4a4a6a;
            --border-light: #3d3d5c;
        }
        body {
            font-family: "Arial", "Microsoft YaHei", sans-serif;
            min-height: 100vh;
            background: var(--bg);
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text);
            transition: background 0.3s, color 0.3s;
        }
        .love-decoration {
            position: fixed;
            font-size: 12px;
            color: var(--primary);
            opacity: 0.3;
            pointer-events: none;
            z-index: -1;
        }
        .auth-panel, .container {
            max-width: 800px;
            width: 100%;
            padding: 35px 30px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(255,107,139,0.15);
            text-align: center;
        }
        .container { display: none; }
        .panel-title {
            color: var(--primary);
            font-size: 28px;
            margin: 0 0 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .panel-subtitle {
            color: var(--text-light);
            font-size: 14px;
            margin: 0 0 25px;
        }
        .form-group { margin-bottom: 20px; }
        .form-control {
            padding: 14px 18px;
            width: 100%;
            max-width: 280px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            outline: none;
            background: var(--card-bg);
            color: var(--text);
        }
        .form-control:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255,107,139,0.1);
        }
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            font-weight: 500;
            margin: 0 8px 10px;
            transition: background 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-secondary:hover { background: var(--secondary-dark); }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-outline:hover { background: rgba(255,107,139,0.1); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-danger:hover { background: #dc2626; }
        .nfc-bind-btn {
            margin: 15px 0 0;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--secondary);
            cursor: pointer;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 30px;
            padding: 0 0 20px;
            border-bottom: 1px solid var(--border-light);
        }
        .couple-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .avatar-group {
            display: flex;
            align-items: center;
            gap: -10px;
        }
        .avatar {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 22px;
            font-weight: bold;
            border: 3px solid var(--card-bg);
            box-shadow: 0 0 0 2px var(--border);
        }
        .love-icon-between {
            position: relative;
            left: -15px;
            background: var(--primary);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
        }
        .couple-nickname { text-align: left; }
        .nickname-pair {
            font-size: 18px;
            color: var(--primary);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .love-days {
            font-size: 13px;
            color: var(--text-light);
            margin: 4px 0 0;
        }
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: var(--text-light);
            font-size: 14px;
        }
        .timer-section, .diary-section, .anniversary-section, .data-section {
            margin: 0 0 30px;
            padding: 25px;
            background: var(--border-light);
            border-radius: 12px;
        }
        .section-title {
            font-size: 20px;
            color: var(--primary);
            margin: 0 0 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .timer-tabs {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin: 0 0 25px;
            flex-wrap: wrap;
        }
        .timer-tab {
            padding: 8px 18px;
            background: var(--card-bg);
            border-radius: 25px;
            cursor: pointer;
            font-size: 15px;
            border: 1px solid var(--border);
        }
        .timer-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .timer-display {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 0 0 20px;
            flex-wrap: wrap;
        }
        .timer-unit { text-align: center; }
        .timer-number {
            width: 85px;
            height: 85px;
            line-height: 85px;
            background: var(--card-bg);
            border-radius: 12px;
            font-size: 32px;
            font-weight: bold;
            color: var(--primary);
            border: 1px solid var(--border);
        }
        .timer-label {
            font-size: 14px;
            color: var(--text-light);
            margin: 8px 0 0;
        }
        .timer-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        .milestone-hint {
            margin: 15px 0 0;
            font-size: 13px;
            color: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .diary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 0 0 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        .diary-filters {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .diary-type-select, .diary-category-select {
            padding: 8px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
            outline: none;
            cursor: pointer;
        }
        .diary-stats {
            font-size: 13px;
            color: var(--text-light);
            display: flex;
            gap: 15px;
        }
        .diary-content {
            width: 100%;
            height: 140px;
            padding: 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            resize: none;
            font-size: 15px;
            background: var(--card-bg);
            color: var(--text);
            margin: 0 0 15px;
        }
        .diary-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .word-count {
            font-size: 13px;
            color: var(--text-light);
        }
        .diary-list {
            max-height: 300px;
            overflow-y: auto;
            margin: 25px 0 0;
            padding-right: 10px;
        }
        .diary-item {
            padding: 18px;
            background: var(--card-bg);
            border-radius: 10px;
            margin: 0 0 15px;
            border: 1px solid var(--border);
            text-align: left;
        }
        .couple-diary { border-left: 4px solid var(--primary); }
        .personal-diary { border-left: 4px solid var(--secondary); }
        .diary-meta {
            display: flex;
            justify-content: space-between;
            margin: 0 0 10px;
        }
        .diary-category-tag {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
            color: white;
            background: var(--primary);
        }
        .diary-category-tag.personal { background: var(--secondary); }
        .diary-time {
            font-size: 12px;
            color: var(--text-light);
        }
        .diary-author {
            font-size: 13px;
            color: var(--primary);
            font-weight: 500;
            margin: 0 0 8px;
        }
        .diary-text {
            line-height: 1.6;
            font-size: 14px;
            margin: 0 0 12px;
        }
        .diary-actions {
            display: flex;
            gap: 10px;
        }
        .anniversary-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 0 0 20px;
        }
        .anniversary-card {
            width: 160px;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 10px;
            border: 1px solid var(--border);
            text-align: center;
            transition: transform 0.2s;
        }
        .anniversary-card:hover { transform: translateY(-3px); }
        .anniversary-icon {
            font-size: 24px;
            color: var(--primary);
            margin: 0 0 8px;
        }
        .anniversary-title {
            font-size: 15px;
            font-weight: 500;
            margin: 0 0 5px;
        }
        .anniversary-date {
            font-size: 13px;
            color: var(--text-light);
            margin: 0 0 8px;
        }
        .anniversary-countdown {
            font-size: 14px;
            color: var(--secondary);
            font-weight: 500;
        }
        .data-actions {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .data-hint {
            margin: 15px 0 0;
            font-size: 13px;
            color: var(--text-light);
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            text-align: center;
        }
        .modal-title {
            font-size: 20px;
            color: var(--primary);
            margin: 0 0 20px;
        }
        .modal-form-group {
            margin: 0 0 20px;
            text-align: left;
        }
        .modal-form-label {
            display: block;
            font-size: 14px;
            margin: 0 0 8px;
            font-weight: 500;
        }
        .modal-footer {
            margin: 25px 0 0;
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        .report-modal-content { max-width: 600px; }
        .report-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            margin: 0 0 25px;
        }
        .report-stat-item {
            text-align: center;
            flex: 1;
            min-width: 120px;
        }
        .report-stat-number {
            font-size: 32px;
            color: var(--primary);
            font-weight: bold;
            margin: 0 0 5px;
        }
        .report-stat-label {
            font-size: 14px;
            color: var(--text-light);
        }
        .milestone-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 40px 30px;
            color: white;
            text-align: center;
            border-radius: 16px;
        }
        @media (max-width: 768px) {
            .header, .couple-info { flex-direction: column; gap: 15px; }
            .couple-nickname { text-align: center; }
            .timer-number { width: 70px; height: 70px; line-height: 70px; font-size: 28px; }
            .anniversary-card { width: 140px; }
        }
        @media (max-width: 480px) {
            .auth-panel, .container { padding: 25px 15px; }
            .form-control, .btn { width: 100%; margin: 0 0 10px; }
            .timer-display { gap: 10px; }
            .timer-number { width: 60px; height: 60px; line-height: 60px; font-size: 24px; }
            .diary-header { align-items: flex-start; }
        }
    </style>
</head>
<body>
    <!-- çˆ±å¿ƒè£…é¥° -->
    <div class="love-decoration" style="top: 10%; left: 5%;">â¤ï¸</div>
    <div class="love-decoration" style="top: 20%; right: 8%;">â¤ï¸</div>
    <div class="love-decoration" style="bottom: 15%; left: 10%;">â¤ï¸</div>
    <div class="love-decoration" style="bottom: 25%; right: 12%;">â¤ï¸</div>

    <!-- ç™»å½•/æ³¨å†Œé¢æ¿ -->
    <div class="auth-panel" id="authPanel">
        <h2 class="panel-title">â¤ï¸ æƒ…ä¾£æ—¶å…‰</h2>
        <p class="panel-subtitle">é’¥åŒ™æ‰£ä¸“å± Â· è®°å½•ä½ ä»¬çš„æ¯ä¸€åˆ»ç¾å¥½</p>
        
        <div class="form-group">
            <input type="text" id="userName" class="form-control" placeholder="è¾“å…¥ç”¨æˆ·å" autocomplete="off">
        </div>
        <div class="form-group">
            <input type="password" id="userPwd" class="form-control" placeholder="è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" autocomplete="off">
        </div>
        <div class="form-group">
            <input type="text" id="coupleNickname" class="form-control" placeholder="ä½ çš„æƒ…ä¾£æ˜µç§°ï¼ˆå¦‚ï¼šå®å®ï¼‰" autocomplete="off">
        </div>
        
        <button onclick="loginAccount()" class="btn btn-primary">ç™»å½•è´¦æˆ·</button>
        <button onclick="createAccount()" class="btn btn-secondary">åˆ›å»ºè´¦æˆ·</button>
        
        <div class="nfc-bind-btn" onclick="nfcQuickBind()">
            <span>ğŸ”‘ ç”¨æƒ…ä¾£é’¥åŒ™æ‰£å¿«é€Ÿç»‘å®š</span>
        </div>
    </div>

    <!-- ä¸»å†…å®¹ -->
    <div class="container" id="mainContent">
        <div class="header">
            <div class="couple-info">
                <div class="avatar-group">
                    <div class="avatar" id="myAvatar" onclick="openAvatarModal('me')">
                        <span id="myAvatarText">æˆ‘</span>
                        <img id="myAvatarImg" style="display: none;" alt="æˆ‘çš„å¤´åƒ">
                    </div>
                    <div class="love-icon-between">â¤ï¸</div>
                    <div class="avatar" id="taAvatar" onclick="openAvatarModal('ta')">
                        <span id="taAvatarText">TA</span>
                        <img id="taAvatarImg" style="display: none;" alt="TAçš„å¤´åƒ">
                    </div>
                </div>
                <div class="couple-nickname">
                    <div class="nickname-pair">
                        <span id="myNickname">æˆ‘</span> & <span id="taNickname">TA</span>
                    </div>
                    <div class="love-days" id="loveDays">æ‹çˆ±ä¸­ Â· å·²é™ªä¼´ 0 å¤©</div>
                </div>
            </div>
            <div class="header-actions">
                <div class="theme-toggle" onclick="toggleDarkMode()">
                    <span id="themeIcon">ğŸŒ™</span>
                    <span id="themeText">é»‘æš—æ¨¡å¼</span>
                </div>
                <button onclick="logoutAccount()" class="btn btn-outline">é€€å‡º</button>
            </div>
        </div>

        <!-- è®¡æ—¶æ¨¡å— -->
        <div class="timer-section">
            <h3 class="section-title">â¤ï¸ çˆ±æƒ…è®¡æ—¶</h3>
            <div class="timer-tabs" id="timerTabs">
                <div class="timer-tab active" data-timer-id="loveDays">æ‹çˆ±å¤©æ•°</div>
                <div class="timer-tab" data-timer-id="nextMeet">ä¸‹æ¬¡è§é¢</div>
                <div class="timer-tab" data-timer-id="bindDay">ç»‘å®šçºªå¿µæ—¥</div>
            </div>
            <div class="timer-display">
                <div class="timer-unit">
                    <div class="timer-number" id="timerDays">00</div>
                    <div class="timer-label">å¤©</div>
                </div>
                <div class="timer-unit">
                    <div class="timer-number" id="timerHours">00</div>
                    <div class="timer-label">æ—¶</div>
                </div>
                <div class="timer-unit">
                    <div class="timer-number" id="timerMinutes">00</div>
                    <div class="timer-label">åˆ†</div>
                </div>
                <div class="timer-unit">
                    <div class="timer-number" id="timerSeconds">00</div>
                    <div class="timer-label">ç§’</div>
                </div>
            </div>
            <div class="timer-actions">
                <button onclick="setLoveStartDate()" class="btn btn-outline">è®¾ç½®æ‹çˆ±èµ·å§‹æ—¥</button>
                <button onclick="setNextMeetDate()" class="btn btn-outline">æ›´æ–°ä¸‹æ¬¡è§é¢</button>
                <button onclick="resetTimer()" class="btn btn-danger" style="display: none;" id="resetTimerBtn">é‡ç½®è®¡æ—¶</button>
            </div>
            <div class="milestone-hint" id="milestoneHint">
                <span>ğŸ“… è·ç¦»ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘ï¼š10å¤©ï¼ˆæ‹çˆ±æ»¡10å¤©ï¼‰</span>
            </div>
            <button onclick="nfcCheckIn()" class="btn btn-secondary">ğŸ”‘ é’¥åŒ™æ‰£æ‰“å¡ï¼ˆä»Šæ—¥è§é¢ï¼‰</button>
        </div>

        <!-- æ—¥è®°æ¨¡å— -->
        <div class="diary-section">
            <h3 class="section-title">â¤ï¸ çˆ±æƒ…æ—¥è®°</h3>
            <div class="diary-header">
                <div class="diary-filters">
                    <select class="diary-type-select" id="diaryTypeSelect" onchange="filterDiaries()">
                        <option value="couple">æƒ…ä¾£æ—¥è®°ï¼ˆåŒæ–¹å¯è§ï¼‰</option>
                        <option value="personal">ä¸ªäººæ—¥è®°ï¼ˆä»…è‡ªå·±å¯è§ï¼‰</option>
                    </select>
                    <select class="diary-category-select" id="diaryCategorySelect" onchange="filterDiaries()">
                        <option value="all">æ‰€æœ‰åˆ†ç±»</option>
                        <option value="çº¦ä¼š">çº¦ä¼š</option>
                        <option value="ç¤¼ç‰©">ç¤¼ç‰©</option>
                        <option value="äº‰åµå’Œè§£">äº‰åµå’Œè§£</option>
                        <option value="å¼‚åœ°æ€å¿µ">å¼‚åœ°æ€å¿µ</option>
                        <option value="å…±åŒç›®æ ‡">å…±åŒç›®æ ‡</option>
                        <option value="å…¶ä»–">å…¶ä»–</option>
                    </select>
                </div>
                <div class="diary-stats">
                    <span>å…±åŒè®°å½•ï¼š<span id="coupleDiaryCount">0</span> ç¯‡</span>
                    <span>æ€»å­—æ•°ï¼š<span id="totalWordCount">0</span> å­—</span>
                </div>
            </div>
            <textarea class="diary-content" id="diaryContent" placeholder="å†™ä¸‹ä½ ä»¬çš„æ•…äº‹..."></textarea>
            <div class="diary-footer">
                <div class="word-count" id="wordCount">0/500 å­—</div>
                <button onclick="saveDiary()" class="btn btn-primary">ä¿å­˜æ—¥è®°</button>
            </div>
            <div class="diary-list" id="diaryList">
                <div style="text-align: center; color: var(--text-light); padding: 20px;">
                    è¿˜æ²¡æœ‰æ—¥è®°å“¦ï½ å†™ä¸‹ä½ ä»¬çš„ç¬¬ä¸€ç¯‡æ•…äº‹å§â¤ï¸
                </div>
            </div>
        </div>

        <!-- çºªå¿µæ—¥æ¨¡å— -->
        <div class="anniversary-section">
            <h3 class="section-title">â¤ï¸ é‡è¦çºªå¿µæ—¥</h3>
            <div class="anniversary-list" id="anniversaryList"></div>
            <button onclick="openAddAnniversaryModal()" class="btn btn-outline">+ æ·»åŠ çºªå¿µæ—¥</button>
        </div>

        <!-- æ•°æ®ç®¡ç† -->
        <div class="data-section">
            <h3 class="section-title">â¤ï¸ çˆ±æƒ…æ•°æ®ç®¡ç†</h3>
            <div class="data-actions">
                <button onclick="exportCoupleData()" class="btn btn-primary">å¯¼å‡ºçˆ±æƒ…çºªå¿µå†Œ</button>
                <button onclick="importCoupleData()" class="btn btn-secondary">å¯¼å…¥æ•°æ®</button>
                <button onclick="generateLoveReport()" class="btn btn-outline">ç”Ÿæˆçˆ±æƒ…æŠ¥å‘Š</button>
            </div>
            <div class="data-hint">
                æ•°æ®æœ¬åœ°å­˜å‚¨ï¼Œå»ºè®®å®šæœŸå¯¼å‡ºå¤‡ä»½ï½ çºªå¿µå†Œå¯æ‰“å°ä½œä¸ºçˆ±æƒ…ä¿¡ç‰©
            </div>
        </div>

        <!-- å…±åŒç›®æ ‡ -->
        <div class="data-section">
            <h3 class="section-title">â¤ï¸ æƒ…ä¾£å…±åŒç›®æ ‡</h3>
            <div style="margin-bottom: 20px;">
                <input type="text" id="goalContent" class="form-control" placeholder="è¾“å…¥å…±åŒç›®æ ‡ï¼ˆå¦‚ï¼šä¸€èµ·å­˜é’±æ—…è¡Œï¼‰" style="margin-bottom: 10px;">
                <button onclick="addCoupleGoal()" class="btn btn-primary">æ·»åŠ ç›®æ ‡</button>
            </div>
            <div id="goalList" style="max-height: 200px; overflow-y: auto; text-align: left;">
                <div style="color: var(--text-light); padding: 10px; text-align: center;">è¿˜æ²¡æœ‰å…±åŒç›®æ ‡ï¼Œä¸€èµ·å®šä¸ªå°ç›®æ ‡å§ï½</div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <div class="modal" id="avatarModal">
        <div class="modal-content">
            <h3 class="modal-title">â¤ï¸ æ›´æ¢å¤´åƒ</h3>
            <input type="file" id="avatarFile" accept="image/*" onchange="previewAvatar()" style="display: none;">
            <button class="btn btn-primary" onclick="document.getElementById('avatarFile').click()">é€‰æ‹©å›¾ç‰‡</button>
            <img id="avatarPreview" style="display: none; width: 120px; height: 120px; border-radius: 50%; margin: 15px auto; object-fit: cover;" alt="å¤´åƒé¢„è§ˆ">
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeAvatarModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveAvatar()">ç¡®è®¤ä¿å­˜</button>
            </div>
        </div>
    </div>

    <div class="modal" id="coupleBindModal">
        <div class="modal-content">
            <h3 class="modal-title">â¤ï¸ ç»‘å®šæƒ…ä¾£è´¦æˆ·</h3>
            <div class="modal-form-group">
                <label class="modal-form-label">é‚€è¯·ç ï¼ˆå¯¹æ–¹ç”Ÿæˆï¼‰</label>
                <input type="text" id="bindCode" class="form-control" placeholder="è¾“å…¥6ä½é‚€è¯·ç ">
            </div>
            <div class="modal-form-group">
                <label class="modal-form-label">TAçš„æ˜µç§°</label>
                <input type="text" id="taBindNickname" class="form-control" placeholder="è¾“å…¥TAçš„æƒ…ä¾£æ˜µç§°">
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeCoupleBindModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="bindCoupleAccount()">ç¡®è®¤ç»‘å®š</button>
            </div>
        </div>
    </div>

    <div class="modal" id="addAnniversaryModal">
        <div class="modal-content">
            <h3 class="modal-title">â¤ï¸ æ·»åŠ çºªå¿µæ—¥</h3>
            <div class="modal-form-group">
                <label class="modal-form-label">çºªå¿µæ—¥åç§°</label>
                <input type="text" id="anniversaryName" class="form-control" placeholder="å¦‚ï¼šæ‹çˆ±çºªå¿µæ—¥ã€TAçš„ç”Ÿæ—¥">
            </div>
            <div class="modal-form-group">
                <label class="modal-form-label">æ—¥æœŸ</label>
                <input type="date" id="anniversaryDate" class="form-control">
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeAddAnniversaryModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveAnniversary()">ç¡®è®¤æ·»åŠ </button>
            </div>
        </div>
    </div>

    <div class="modal" id="loveReportModal">
        <div class="modal-content report-modal-content">
            <h3 class="modal-title">â¤ï¸ ä½ ä»¬çš„çˆ±æƒ…æˆé•¿æŠ¥å‘Š</h3>
            <p class="panel-subtitle" id="reportDate">ç”Ÿæˆæ—¶é—´ï¼š2024å¹´XæœˆXæ—¥</p>
            <div class="report-stats">
                <div class="report-stat-item">
                    <div class="report-stat-number" id="reportLoveDays">0</div>
                    <div class="report-stat-label">æ‹çˆ±å¤©æ•°</div>
                </div>
                <div class="report-stat-item">
                    <div class="report-stat-number" id="reportDiaryCount">0</div>
                    <div class="report-stat-label">å…±åŒæ—¥è®°</div>
                </div>
                <div class="report-stat-item">
                    <div class="report-stat-number" id="reportWordCount">0</div>
                    <div class="report-stat-label">æ€»å­—æ•°</div>
                </div>
                <div class="report-stat-item">
                    <div class="report-stat-number" id="reportMilestoneCount">0</div>
                    <div class="report-stat-label">è¾¾æˆé‡Œç¨‹ç¢‘</div>
                </div>
            </div>
            <div style="line-height: 1.6; font-size: 14px; margin: 20px 0;">
                <p>äº²çˆ±çš„ <span id="reportNickname1">æˆ‘</span> å’Œ <span id="reportNickname2">TA</span>ï¼š</p>
                <p>ä½ ä»¬å·²ç»æºæ‰‹èµ°è¿‡äº† <span id="reportLoveDaysText">0</span> å¤©ï¼Œå…±åŒè®°å½•äº† <span id="reportDiaryCountText">0</span> ç¯‡æ—¥è®°ï¼Œå†™ä¸‹äº† <span id="reportWordCountText">0</span> å­—çš„ç¾å¥½å›å¿†ã€‚</p>
                <p>ä½ ä»¬ä¸€èµ·ç»å†äº† <span id="reportMilestoneCountText">0</span> ä¸ªé‡è¦é‡Œç¨‹ç¢‘ï¼Œæ¯ä¸€ä¸ªç¬é—´éƒ½å€¼å¾—è¢«çè—ã€‚</p>
                <p style="color: var(--primary); font-weight: 500;">æ„¿ä½ ä»¬æ°¸è¿œç›¸çˆ±ï¼Œæºæ‰‹å¥”èµ´æ›´è¿œçš„æœªæ¥ï½â¤ï¸</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="downloadLoveReport()">ä¸‹è½½æŠ¥å‘Š</button>
            </div>
        </div>
    </div>

    <div class="modal" id="milestoneModal">
        <div class="modal-content">
            <div class="milestone-card">
                <div class="milestone-card-icon">ğŸ‰</div>
                <div class="milestone-card-title" id="milestoneTitle">æ‹çˆ±æ»¡10å¤©å•¦ï¼</div>
                <div class="milestone-card-desc" id="milestoneDesc">ä½ ä»¬å·²ç»æºæ‰‹èµ°è¿‡äº†10ä¸ªæ—¥å¤œï¼Œç»§ç»­ç”œèœœä¸‹å»å§ï½</div>
                <div class="milestone-card-date" id="milestoneDate">2024å¹´XæœˆXæ—¥</div>
                <div class="milestone-card-actions">
                    <button class="btn btn-outline" style="color: white; border-color: white;" onclick="saveMilestoneCard()">ä¿å­˜çºªå¿µå¡ç‰‡</button>
                    <button class="btn btn-outline" style="color: white; border-color: white;" onclick="closeMilestoneModal()">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- éŸ³ä¹ -->
    <audio id="musicPlayer" loop preload="auto">
        <source src="https://cdn.freesound.org/previews/501/501680_10226512-lq.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
    </audio>

    <script>
        // å…¨å±€çŠ¶æ€
        const state = {
            currentUser: null,
            coupleData: null,
            currentTimerId: 'loveDays',
            timerInterval: null,
            activeAvatarType: 'me',
            config: {
                milestones: [7, 30, 52, 100, 131, 200, 365, 520, 1314],
                defaultAnniversaries: [
                    { id: 'loveStart', name: 'æ‹çˆ±çºªå¿µæ—¥', date: '', icon: 'â¤ï¸' },
                    { id: 'firstDate', name: 'ç¬¬ä¸€æ¬¡çº¦ä¼š', date: '', icon: 'ğŸ’‘' },
                    { id: 'bindDay', name: 'ç»‘å®šçºªå¿µæ—¥', date: new Date().toISOString().split('T')[0], icon: 'ğŸ”—' }
                ]
            }
        };

        // åˆå§‹åŒ–é»˜è®¤æ•°æ®
        const initDefaultData = () => ({
            myNickname: '',
            taNickname: '',
            isBound: false,
            bindCode: '',
            loveStartDate: '',
            nextMeetDate: '',
            timers: {
                loveDays: { startDate: '', name: 'æ‹çˆ±å¤©æ•°' },
                nextMeet: { startDate: '', name: 'ä¸‹æ¬¡è§é¢' },
                bindDay: { startDate: new Date().toISOString().split('T')[0], name: 'ç»‘å®šçºªå¿µæ—¥' }
            },
            diaries: [],
            anniversaries: [...state.config.defaultAnniversaries],
            avatars: { me: '', ta: '' },
            darkMode: false,
            passedMilestones: [],
            lastMilestoneCheck: '',
            hasShownGuide: false,
            coupleGoals: []
        });

        // DOMåŠ è½½å®Œæˆåˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            state.coupleData = initDefaultData();
            generateLoveDecorations();
            checkDarkMode();
            initMusic();
            renderAnniversaries(); // åˆå§‹åŒ–çºªå¿µæ—¥åˆ—è¡¨
            bindDiaryWordCount(); // ç»‘å®šæ—¥è®°å­—æ•°ç»Ÿè®¡

            // ç»‘å®šæŒ‰é’®äº‹ä»¶ï¼ˆåŒé‡ä¿éšœï¼‰
            document.querySelector('.btn-primary').addEventListener('click', loginAccount);
            document.querySelector('.btn-secondary').addEventListener('click', createAccount);
        });

        // å·¥å…·å‡½æ•°
        const getAccounts = () => JSON.parse(localStorage.getItem('coupleAccounts') || '[]');
        const saveCoupleData = () => {
            if (!state.currentUser) return;
            const accounts = getAccounts();
            const idx = accounts.findIndex(a => a.userName === state.currentUser);
            if (idx !== -1) {
                accounts[idx].coupleData = state.coupleData;
                localStorage.setItem('coupleAccounts', JSON.stringify(accounts));
            }
        };

        // ç™»å½•åŠŸèƒ½
        function loginAccount() {
            const userName = document.getElementById('userName').value.trim();
            const userPwd = document.getElementById('userPwd').value.trim();
            const loginBtn = document.querySelector('.btn-primary');
            
            // æŒ‰é’®çŠ¶æ€åˆ‡æ¢
            loginBtn.disabled = true;
            loginBtn.textContent = 'ç™»å½•ä¸­...';

            try {
                if (!userName || !userPwd) throw new Error('ç”¨æˆ·åæˆ–å¯†ç ä¸èƒ½ä¸ºç©ºï¼');
                
                const accounts = getAccounts();
                const account = accounts.find(a => a.userName === userName && a.password === userPwd);
                if (!account) throw new Error('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼');

                // ç™»å½•æˆåŠŸ
                state.currentUser = userName;
                state.coupleData = account.coupleData;
                
                // ç•Œé¢åˆ‡æ¢
                document.getElementById('authPanel').style.display = 'none';
                const mainContent = document.getElementById('mainContent');
                mainContent.style.display = 'block';
                mainContent.style.opacity = '0';
                setTimeout(() => mainContent.style.opacity = '1', 100);

                initCoupleInterface();
                document.getElementById('userName').value = '';
                document.getElementById('userPwd').value = '';
                alert(`æ¬¢è¿å›æ¥ï¼Œ${state.coupleData.myNickname || userName}ï½`);
            } catch (err) {
                alert(err.message);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ç™»å½•è´¦æˆ·';
            }
        }

        // åˆ›å»ºè´¦æˆ·
        function createAccount() {
            const userName = document.getElementById('userName').value.trim();
            const userPwd = document.getElementById('userPwd').value.trim();
            const nickname = document.getElementById('coupleNickname').value.trim();
            const createBtn = document.querySelectorAll('.btn')[1];

            createBtn.disabled = true;
            createBtn.textContent = 'åˆ›å»ºä¸­...';

            try {
                if (!userName) throw new Error('ç”¨æˆ·åä¸èƒ½ä¸ºç©ºï¼');
                if (!userPwd || userPwd.length < 6) throw new Error('å¯†ç ä¸èƒ½ä¸ºç©ºä¸”é•¿åº¦è‡³å°‘6ä½ï¼');
                if (!nickname) throw new Error('æƒ…ä¾£æ˜µç§°ä¸èƒ½ä¸ºç©ºï¼');

                const accounts = getAccounts();
                if (accounts.some(a => a.userName === userName)) throw new Error('ç”¨æˆ·åå·²å­˜åœ¨ï¼');

                const bindCode = Math.floor(100000 + Math.random() * 900000).toString();
                const newAccount = {
                    userName,
                    password: userPwd,
                    coupleData: { ...initDefaultData(), myNickname: nickname, bindCode }
                };

                accounts.push(newAccount);
                localStorage.setItem('coupleAccounts', JSON.stringify(accounts));
                alert(`è´¦æˆ·åˆ›å»ºæˆåŠŸï¼\næƒ…ä¾£é‚€è¯·ç ï¼š${bindCode}\nè¯·åˆ†äº«ç»™TAç»‘å®šï½`);

                document.getElementById('userName').value = '';
                document.getElementById('userPwd').value = '';
                document.getElementById('coupleNickname').value = '';
            } catch (err) {
                alert(err.message);
            } finally {
                createBtn.disabled = false;
                createBtn.textContent = 'åˆ›å»ºè´¦æˆ·';
            }
        }

        // é€€å‡ºç™»å½•
        function logoutAccount() {
            if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
                if (state.timerInterval) clearInterval(state.timerInterval);
                document.getElementById('mainContent').style.display = 'none';
                document.getElementById('authPanel').style.display = 'block';
                state.currentUser = null;
                state.coupleData = initDefaultData();
            }
        }

        // åˆå§‹åŒ–æƒ…ä¾£ç•Œé¢
        function initCoupleInterface() {
            document.getElementById('myNickname').textContent = state.coupleData.myNickname;
            document.getElementById('taNickname').textContent = state.coupleData.taNickname || 'TA';
            updateAvatars();
            updateLoveDays();
            renderTimerTabs();
            initTimer();
            renderDiaries();
            updateDiaryStats();
            checkMilestones();
            initGoals();

            if (!state.coupleData.hasShownGuide) {
                setTimeout(() => {
                    alert(`â¤ï¸ æ–°æ‰‹å¼•å¯¼\n1. å…ˆè®¾ç½®ã€Œæ‹çˆ±èµ·å§‹æ—¥ã€è®°å½•é™ªä¼´æ—¶é•¿\n2. å‘å¸ƒã€Œæƒ…ä¾£æ—¥è®°ã€å’ŒTAå…±åŒè®°å½•\n3. æ·»åŠ ã€Œé‡è¦çºªå¿µæ—¥ã€é¿å…å¿˜è®°æƒŠå–œ\n4. ç”¨æƒ…ä¾£é’¥åŒ™æ‰£NFCå¿«é€Ÿæ‰“å¡/äº’åŠ¨`);
                    state.coupleData.hasShownGuide = true;
                    saveCoupleData();
                }, 1000);
            }
        }

        // è®¡æ—¶ç›¸å…³
        function renderTimerTabs() {
            const tabsEl = document.getElementById('timerTabs');
            tabsEl.innerHTML = '';
            Object.keys(state.coupleData.timers).forEach(id => {
                const tab = document.createElement('div');
                tab.className = `timer-tab ${id === state.currentTimerId ? 'active' : ''}`;
                tab.dataset.timerId = id;
                tab.textContent = state.coupleData.timers[id].name;
                tab.onclick = () => {
                    state.currentTimerId = id;
                    renderTimerTabs();
                    initTimer();
                    updateMilestoneHint();
                };
                tabsEl.appendChild(tab);
            });
        }

        function initTimer() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            const timer = state.coupleData.timers[state.currentTimerId];
            if (!timer.startDate) {
                ['Days', 'Hours', 'Minutes', 'Seconds'].forEach(key => {
                    document.getElementById(`timer${key}`).textContent = '00';
                });
                return;
            }
            updateTimer();
            state.timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const timer = state.coupleData.timers[state.currentTimerId];
            const start = new Date(timer.startDate);
            const now = new Date();
            const diff = state.currentTimerId === 'nextMeet' 
                ? Math.max(0, start - now) 
                : now - start;

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            document.getElementById('timerDays').textContent = days.toString().padStart(2, '0');
            document.getElementById('timerHours').textContent = hours.toString().padStart(2, '0');
            document.getElementById('timerMinutes').textContent = minutes.toString().padStart(2, '0');
            document.getElementById('timerSeconds').textContent = seconds.toString().padStart(2, '0');
        }

        function setLoveStartDate() {
            const date = prompt('è¯·è¾“å…¥æ‹çˆ±èµ·å§‹æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰', state.coupleData.loveStartDate || new Date().toISOString().split('T')[0]);
            if (!date) return;
            if (isNaN(new Date(date).getTime())) {
                alert('æ—¥æœŸæ ¼å¼é”™è¯¯ï¼');
                return;
            }
            state.coupleData.loveStartDate = date;
            state.coupleData.timers.loveDays.startDate = date;
            saveCoupleData();
            initTimer();
            updateLoveDays();
            checkMilestones();
        }

        function setNextMeetDate() {
            const date = prompt('è¯·è¾“å…¥ä¸‹æ¬¡è§é¢æ—¥æœŸï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰', state.coupleData.nextMeetDate || new Date().toISOString().split('T')[0]);
            if (!date) return;
            if (isNaN(new Date(date).getTime())) {
                alert('æ—¥æœŸæ ¼å¼é”™è¯¯ï¼');
                return;
            }
            state.coupleData.nextMeetDate = date;
            state.coupleData.timers.nextMeet.startDate = date;
            saveCoupleData();
            initTimer();
            if (state.coupleData.isBound) {
                alert(`å·²é€šçŸ¥${state.coupleData.taNickname}ï¼šä½ æ›´æ–°äº†ä¸‹æ¬¡è§é¢æ—¶é—´ï¼`);
            }
        }

        function resetTimer() {
            if (confirm(`ç¡®å®šè¦é‡ç½®${state.coupleData.timers[state.currentTimerId].name}å—ï¼Ÿ`)) {
                state.coupleData.timers[state.currentTimerId].startDate = new Date().toISOString().split('T')[0];
                saveCoupleData();
                initTimer();
            }
        }

        function updateLoveDays() {
            if (!state.coupleData.loveStartDate) {
                document.getElementById('loveDays').textContent = 'æ‹çˆ±ä¸­ Â· å·²é™ªä¼´ 0 å¤©';
                return;
            }
            const days = Math.floor((new Date() - new Date(state.coupleData.loveStartDate)) / (1000 * 60 * 60 * 24));
            document.getElementById('loveDays').textContent = `æ‹çˆ±ä¸­ Â· å·²é™ªä¼´ ${days} å¤©`;
        }

        function updateMilestoneHint() {
            if (state.currentTimerId !== 'loveDays' || !state.coupleData.loveStartDate) {
                document.getElementById('milestoneHint').style.display = 'none';
                return;
            }
            const days = Math.floor((new Date() - new Date(state.coupleData.loveStartDate)) / (1000 * 60 * 60 * 24));
            const next = state.config.milestones.find(m => m > days);
            if (next) {
                document.getElementById('milestoneHint').innerHTML = `ğŸ“… è·ç¦»ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘ï¼š${next - days}å¤©ï¼ˆæ‹çˆ±æ»¡${next}å¤©ï¼‰`;
                document.getElementById('milestoneHint').style.display = 'flex';
            } else {
                document.getElementById('milestoneHint').innerHTML = `ğŸ‰ å·²è¾¾æˆæ‰€æœ‰é‡Œç¨‹ç¢‘ï¼ä½ ä»¬çš„çˆ±æƒ…å¤ªé•¿ä¹…å•¦ï½`;
                document.getElementById('milestoneHint').style.display = 'flex';
            }
        }

        // æ—¥è®°ç›¸å…³
        function bindDiaryWordCount() {
            const contentEl = document.getElementById('diaryContent');
            contentEl.addEventListener('input', () => {
                const len = contentEl.value.length;
                document.getElementById('wordCount').textContent = `${Math.min(len, 500)}/500 å­—`;
                if (len > 500) contentEl.value = contentEl.value.substring(0, 500);
            });
        }

        function saveDiary() {
            const content = document.getElementById('diaryContent').value.trim();
            const type = document.getElementById('diaryTypeSelect').value;
            const category = document.getElementById('diaryCategorySelect').value;

            if (!content) {
                alert('æ—¥è®°å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            const diary = {
                id: Date.now(),
                type,
                category,
                content,
                author: state.coupleData.myNickname,
                date: new Date().toLocaleDateString(),
                time: new Date().toLocaleTimeString(),
                reply: null
            };

            state.coupleData.diaries.unshift(diary);
            saveCoupleData();
            contentEl.value = '';
            document.getElementById('wordCount').textContent = '0/500 å­—';
            renderDiaries();
            updateDiaryStats();

            if (type === 'couple' && state.coupleData.isBound) {
                alert(`å·²é€šçŸ¥${state.coupleData.taNickname}ï¼šä½ å‘å¸ƒäº†æ–°çš„æƒ…ä¾£æ—¥è®°ï½`);
            }
        }

        function renderDiaries() {
            const listEl = document.getElementById('diaryList');
            const type = document.getElementById('diaryTypeSelect').value;
            const category = document.getElementById('diaryCategorySelect').value;

            let diaries = state.coupleData.diaries.filter(d => d.type === type);
            if (category !== 'all') diaries = diaries.filter(d => d.category === category);

            if (diaries.length === 0) {
                listEl.innerHTML = `<div style="text-align: center; color: var(--text-light); padding: 20px;">è¿˜æ²¡æœ‰æ—¥è®°å“¦ï½ å†™ä¸‹ä½ ä»¬çš„ç¬¬ä¸€ç¯‡æ•…äº‹å§â¤ï¸</div>`;
                return;
            }

            listEl.innerHTML = diaries.map(diary => `
                <div class="diary-item ${diary.type === 'couple' ? 'couple-diary' : 'personal-diary'}">
                    <div class="diary-meta">
                        <span class="diary-category-tag ${diary.type === 'personal' ? 'personal' : ''}">${diary.category}</span>
                        <span class="diary-time">${diary.date} ${diary.time}</span>
                    </div>
                    <div class="diary-author">${diary.author} çš„${diary.type === 'couple' ? 'æƒ…ä¾£' : 'ä¸ªäºº'}æ—¥è®°</div>
                    <div class="diary-text">${diary.content}</div>
                    <div class="diary-actions">
                        <button class="btn btn-outline" onclick="deleteDiary(${diary.id})">åˆ é™¤</button>
                        ${diary.type === 'couple' ? `<button class="btn btn-outline" onclick="replyToDiary(${diary.id})">å›å¤</button>` : ''}
                    </div>
                    ${diary.reply ? `
                        <div class="diary-reply">
                            <div class="reply-header">ğŸ’¬ ${diary.reply.author} çš„å›å¤ï¼ˆ${diary.reply.time}ï¼‰</div>
                            <div class="reply-content">${diary.reply.content}</div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function filterDiaries() {
            renderDiaries();
        }

        function deleteDiary(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡æ—¥è®°å—ï¼Ÿ')) {
                state.coupleData.diaries = state.coupleData.diaries.filter(d => d.id !== id);
                saveCoupleData();
                renderDiaries();
                updateDiaryStats();
            }
        }

        function replyToDiary(id) {
            const content = prompt('è¯·è¾“å…¥å›å¤å†…å®¹ï¼š');
            if (!content) return;
            const diary = state.coupleData.diaries.find(d => d.id === id);
            if (diary) {
                diary.reply = {
                    author: state.coupleData.myNickname,
                    content,
                    time: new Date().toLocaleString()
                };
                saveCoupleData();
                renderDiaries();
                if (state.coupleData.isBound) {
                    alert(`å·²é€šçŸ¥${state.coupleData.taNickname}ï¼šä½ å›å¤äº†æƒ…ä¾£æ—¥è®°ï½`);
                }
            }
        }

        function updateDiaryStats() {
            const coupleDiaries = state.coupleData.diaries.filter(d => d.type === 'couple').length;
            const totalWords = state.coupleData.diaries.reduce((sum, d) => sum + d.content.length, 0);
            document.getElementById('coupleDiaryCount').textContent = coupleDiaries;
            document.getElementById('totalWordCount').textContent = totalWords;
        }

        // çºªå¿µæ—¥ç›¸å…³
        function renderAnniversaries() {
            const listEl = document.getElementById('anniversaryList');
            listEl.innerHTML = state.coupleData.anniversaries.map(ann => {
                let countdown = 'æœªè®¾ç½®æ—¥æœŸ';
                if (ann.date) {
                    const now = new Date();
                    const annDate = new Date(ann.date);
                    annDate.setFullYear(now.getFullYear());
                    if (annDate < now) annDate.setFullYear(now.getFullYear() + 1);
                    const days = Math.ceil((annDate - now) / (1000 * 60 * 60 * 24));
                    countdown = `${days}å¤©å`;
                }
                return `
                    <div class="anniversary-card">
                        <div class="anniversary-icon">${ann.icon}</div>
                        <div class="anniversary-title">${ann.name}</div>
                        <div class="anniversary-date">${ann.date || 'æœªè®¾ç½®'}</div>
                        <div class="anniversary-countdown">${countdown}</div>
                    </div>
                `;
            }).join('');
        }

        function openAddAnniversaryModal() {
            document.getElementById('addAnniversaryModal').style.display = 'flex';
        }

        function closeAddAnniversaryModal() {
            document.getElementById('addAnniversaryModal').style.display = 'none';
            document.getElementById('anniversaryName').value = '';
            document.getElementById('anniversaryDate').value = '';
        }

        function saveAnniversary() {
            const name = document.getElementById('anniversaryName').value.trim();
            const date = document.getElementById('anniversaryDate').value;
            if (!name) {
                alert('çºªå¿µæ—¥åç§°ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            if (!date) {
                alert('è¯·é€‰æ‹©çºªå¿µæ—¥æ—¥æœŸï¼');
                return;
            }

            state.coupleData.anniversaries.push({
                id: Date.now().toString(),
                name,
                date,
                icon: 'ğŸ‰'
            });
            saveCoupleData();
            renderAnniversaries();
            closeAddAnniversaryModal();
        }

        // é‡Œç¨‹ç¢‘ç›¸å…³
        function checkMilestones() {
            if (state.currentTimerId !== 'loveDays' || !state.coupleData.loveStartDate) return;
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            if (state.coupleData.lastMilestoneCheck === today) return;

            const days = Math.floor((now - new Date(state.coupleData.loveStartDate)) / (1000 * 60 * 60 * 24));
            const newMilestones = state.config.milestones.filter(m => 
                m <= days && !state.coupleData.passedMilestones.includes(m)
            );

            if (newMilestones.length > 0) {
                const milestone = newMilestones[0];
                state.coupleData.passedMilestones.push(milestone);
                state.coupleData.lastMilestoneCheck = today;
                saveCoupleData();
                showMilestoneModal(milestone, days);
            }
        }

        function showMilestoneModal(milestone, days) {
            const titles = {
                7: 'æ‹çˆ±æ»¡1å‘¨å•¦ï¼',
                30: 'æ‹çˆ±æ»¡1ä¸ªæœˆï¼',
                52: 'æ‹çˆ±æ»¡52å¤©ï¼',
                100: 'æ‹çˆ±æ»¡100å¤©ï¼',
                131: 'æ‹çˆ±æ»¡131å¤©ï¼',
                200: 'æ‹çˆ±æ»¡200å¤©ï¼',
                365: 'æ‹çˆ±æ»¡1å¹´ï¼',
                520: 'æ‹çˆ±æ»¡520å¤©ï¼',
                1314: 'æ‹çˆ±æ»¡1314å¤©ï¼'
            };
            const descs = {
                7: 'ä½ ä»¬å·²ç»ç”œèœœç›¸ä¼´7å¤©ï¼Œæ„¿æ¯å‘¨éƒ½å¦‚åˆè§èˆ¬ç¾å¥½ï½',
                30: '30å¤©çš„é™ªä¼´ï¼Œæ˜¯çˆ±æƒ…çš„èŒèŠ½ï¼Œç»§ç»­èŒå£®æˆé•¿å§ï½',
                52: '52å¤©=æˆ‘çˆ±ä½ ï¼Œè¿™æ˜¯å±äºä½ ä»¬çš„çˆ±æƒ…å¯†ç ï½',
                100: 'ç™¾æ—¥åŒè¡Œï¼Œåˆå¿ƒä¸å˜ï¼Œæœªæ¥è¿˜æœ‰æ›´å¤šç²¾å½©ï½',
                131: '131å¤©=ä¸€ç”Ÿä¸€ä¸–ï¼Œæ„¿ä½ ä»¬æ°¸è¿œç›¸çˆ±ï½',
                200: '200å¤©çš„ç‚¹ç‚¹æ»´æ»´ï¼Œéƒ½æ˜¯çè´µçš„å›å¿†ï½',
                365: '365å¤©çš„é™ªä¼´ï¼Œæ˜¯çˆ±æƒ…çš„é‡Œç¨‹ç¢‘ï¼Œç¥å‘¨å¹´å¿«ä¹ï½',
                520: '520=æˆ‘çˆ±ä½ ï¼Œè¿™æ˜¯æœ€æµªæ¼«çš„æ•°å­—ï¼Œç¥ä½ ä»¬æ°¸è¿œç”œèœœï½',
                1314: '1314å¤©=ä¸€ç”Ÿä¸€ä¸–ï¼Œæ„¿ä½ ä»¬ç›¸å®ˆä¸€ç”Ÿï¼Œç™½å¤´å•è€ï½'
            };

            document.getElementById('milestoneTitle').textContent = titles[milestone] || `æ‹çˆ±æ»¡${milestone}å¤©ï¼`;
            document.getElementById('milestoneDesc').textContent = descs[milestone] || `ä½ ä»¬å·²ç»æºæ‰‹èµ°è¿‡${milestone}å¤©ï¼Œç»§ç»­ç”œèœœä¸‹å»å§ï½`;
            document.getElementById('milestoneDate').textContent = now.toLocaleDateString();
            document.getElementById('milestoneModal').style.display = 'flex';
        }

        function closeMilestoneModal() {
            document.getElementById('milestoneModal').style.display = 'none';
        }

        function saveMilestoneCard() {
            alert('çºªå¿µå¡ç‰‡å·²ä¿å­˜åˆ°æœ¬åœ°ï¼ï¼ˆå®é™…é¡¹ç›®ä¸­å¯å®ç°å›¾ç‰‡ä¸‹è½½åŠŸèƒ½ï¼‰');
            closeMilestoneModal();
        }

        // å¤´åƒç›¸å…³
        function openAvatarModal(type) {
            state.activeAvatarType = type;
            document.getElementById('avatarModal').style.display = 'flex';
        }

        function closeAvatarModal() {
            document.getElementById('avatarModal').style.display = 'none';
            document.getElementById('avatarFile').value = '';
            document.getElementById('avatarPreview').style.display = 'none';
        }

        function previewAvatar() {
            const file = document.getElementById('avatarFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById('avatarPreview');
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function saveAvatar() {
            const preview = document.getElementById('avatarPreview');
            if (!preview.src) {
                alert('è¯·å…ˆé€‰æ‹©å›¾ç‰‡ï¼');
                return;
            }
            state.coupleData.avatars[state.activeAvatarType] = preview.src;
            saveCoupleData();
            updateAvatars();
            closeAvatarModal();
        }

        function updateAvatars() {
            const myAvatar = state.coupleData.avatars.me;
            const taAvatar = state.coupleData.avatars.ta;
            
            if (myAvatar) {
                document.getElementById('myAvatarImg').src = myAvatar;
                document.getElementById('myAvatarImg').style.display = 'block';
                document.getElementById('myAvatarText').style.display = 'none';
            } else {
                document.getElementById('myAvatarImg').style.display = 'none';
                document.getElementById('myAvatarText').style.display = 'block';
            }

            if (taAvatar) {
                document.getElementById('taAvatarImg').src = taAvatar;
                document.getElementById('taAvatarImg').style.display = 'block';
                document.getElementById('taAvatarText').style.display = 'none';
            } else {
                document.getElementById('taAvatarImg').style.display = 'none';
                document.getElementById('taAvatarText').style.display = 'block';
            }
        }

        // æƒ…ä¾£ç»‘å®š
        function nfcQuickBind() {
            document.getElementById('coupleBindModal').style.display = 'flex';
        }

        function closeCoupleBindModal() {
            document.getElementById('coupleBindModal').style.display = 'none';
            document.getElementById('bindCode').value = '';
            document.getElementById('taBindNickname').value = '';
        }

        function bindCoupleAccount() {
            const bindCode = document.getElementById('bindCode').value.trim();
            const taNickname = document.getElementById('taBindNickname').value.trim();

            if (!bindCode || bindCode.length !== 6) {
                alert('è¯·è¾“å…¥6ä½é‚€è¯·ç ï¼');
                return;
            }
            if (!taNickname) {
                alert('è¯·è¾“å…¥TAçš„æ˜µç§°ï¼');
                return;
            }

            const accounts = getAccounts();
            const targetAccount = accounts.find(a => a.coupleData.bindCode === bindCode && !a.coupleData.isBound);

            if (!targetAccount) {
                alert('é‚€è¯·ç æ— æ•ˆæˆ–å·²ç»‘å®šï¼');
                return;
            }

            // æ›´æ–°åŒæ–¹ç»‘å®šçŠ¶æ€
            state.coupleData.isBound = true;
            state.coupleData.taNickname = taNickname;
            state.coupleData.anniversaries = targetAccount.coupleData.anniversaries;
            state.coupleData.loveStartDate = targetAccount.coupleData.loveStartDate || new Date().toISOString().split('T')[0];
            state.coupleData.timers.loveDays.startDate = state.coupleData.loveStartDate;

            const currentIdx = accounts.findIndex(a => a.userName === state.currentUser);
            const targetIdx = accounts.findIndex(a => a.userName === targetAccount.userName);

            accounts[currentIdx].coupleData = state.coupleData;
            accounts[targetIdx].coupleData.isBound = true;
            accounts[targetIdx].coupleData.taNickname = state.coupleData.myNickname;

            localStorage.setItem('coupleAccounts', JSON.stringify(accounts));
            alert(`ç»‘å®šæˆåŠŸï¼ç°åœ¨å¯ä»¥å’Œ${taNickname}ä¸€èµ·è®°å½•çˆ±æƒ…å•¦ï½`);
            closeCoupleBindModal();
            initCoupleInterface();
        }

        // å…±åŒç›®æ ‡
        function initGoals() {
            const listEl = document.getElementById('goalList');
            if (state.coupleData.coupleGoals.length === 0) {
                listEl.innerHTML = `<div style="color: var(--text-light); padding: 10px; text-align: center;">è¿˜æ²¡æœ‰å…±åŒç›®æ ‡ï¼Œä¸€èµ·å®šä¸ªå°ç›®æ ‡å§ï½</div>`;
                return;
            }
            listEl.innerHTML = state.coupleData.coupleGoals.map((goal, idx) => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border-light); display: flex; justify-content: space-between; align-items: center;">
                    <span>${goal}</span>
                    <button class="btn btn-outline" onclick="deleteGoal(${idx})">åˆ é™¤</button>
                </div>
            `).join('');
        }

        function addCoupleGoal() {
            const content = document.getElementById('goalContent').value.trim();
            if (!content) {
                alert('ç›®æ ‡å†…å®¹ä¸èƒ½ä¸ºç©ºï¼');
                return;
            }
            state.coupleData.coupleGoals.push(content);
            saveCoupleData();
            initGoals();
            document.getElementById('goalContent').value = '';
            if (state.coupleData.isBound) {
                alert(`å·²é€šçŸ¥${state.coupleData.taNickname}ï¼šä½ æ·»åŠ äº†æ–°çš„å…±åŒç›®æ ‡ï½`);
            }
        }

        function deleteGoal(idx) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªç›®æ ‡å—ï¼Ÿ')) {
                state.coupleData.coupleGoals.splice(idx, 1);
                saveCoupleData();
                initGoals();
            }
        }

        // æ•°æ®å¯¼å‡ºå¯¼å…¥
        function exportCoupleData() {
            const dataStr = JSON.stringify(state.coupleData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `æƒ…ä¾£æ—¶å…‰_${state.coupleData.myNickname}_${new Date().toLocaleDateString()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importCoupleData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = res => {
                    try {
                        const data = JSON.parse(res.target.result);
                        // éªŒè¯æ•°æ®æ ¼å¼
                        if (data.myNickname && data.anniversaries && data.diaries) {
                            state.coupleData = data;
                            saveCoupleData();
                            initCoupleInterface();
                            alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                        } else {
                            alert('æ•°æ®æ ¼å¼é”™è¯¯ï¼');
                        }
                    } catch (err) {
                        alert('æ•°æ®è§£æå¤±è´¥ï¼');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // çˆ±æƒ…æŠ¥å‘Š
        function generateLoveReport() {
            const now = new Date();
            const loveDays = state.coupleData.loveStartDate 
                ? Math.floor((now - new Date(state.coupleData.loveStartDate)) / (1000 * 60 * 60 * 24)) 
                : 0;
            const coupleDiaries = state.coupleData.diaries.filter(d => d.type === 'couple').length;
            const totalWords = state.coupleData.diaries.reduce((sum, d) => sum + d.content.length, 0);
            const milestoneCount = state.coupleData.passedMilestones.length;

            document.getElementById('reportDate').textContent = `ç”Ÿæˆæ—¶é—´ï¼š${now.toLocaleDateString()}`;
            document.getElementById('reportLoveDays').textContent = loveDays;
            document.getElementById('reportDiaryCount').textContent = coupleDiaries;
            document.getElementById('reportWordCount').textContent = totalWords;
            document.getElementById('reportMilestoneCount').textContent = milestoneCount;

            document.getElementById('reportNickname1').textContent = state.coupleData.myNickname;
            document.getElementById('reportNickname2').textContent = state.coupleData.taNickname || 'TA';
            document.getElementById('reportLoveDaysText').textContent = loveDays;
            document.getElementById('reportDiaryCountText').textContent = coupleDiaries;
            document.getElementById('reportWordCountText').textContent = totalWords;
            document.getElementById('reportMilestoneCountText').textContent = milestoneCount;

            document.getElementById('loveReportModal').style.display = 'flex';
        }

        function downloadLoveReport() {
            // ç®€å•å®ç°ï¼šå°†æŠ¥å‘Šå†…å®¹è½¬ä¸ºæ–‡æœ¬ä¸‹è½½
            const reportText = `
            æƒ…ä¾£æ—¶å…‰ - çˆ±æƒ…æˆé•¿æŠ¥å‘Š
            ç”Ÿæˆæ—¶é—´ï¼š${document.getElementById('reportDate').textContent.split('ï¼š')[1]}
            æƒ…ä¾£æ˜µç§°ï¼š${state.coupleData.myNickname} & ${state.coupleData.taNickname || 'TA'}
            
            æ ¸å¿ƒæ•°æ®ï¼š
            - æ‹çˆ±å¤©æ•°ï¼š${document.getElementById('reportLoveDays').textContent} å¤©
            - å…±åŒæ—¥è®°ï¼š${document.getElementById('reportDiaryCount').textContent} ç¯‡
            - æ€»è®°å½•å­—æ•°ï¼š${document.getElementById('reportWordCount').textContent} å­—
            - è¾¾æˆé‡Œç¨‹ç¢‘ï¼š${document.getElementById('reportMilestoneCount').textContent} ä¸ª
            
            å¯„è¯­ï¼š
            äº²çˆ±çš„ ${state.coupleData.myNickname} å’Œ ${state.coupleData.taNickname || 'TA'}ï¼š
            ä½ ä»¬å·²ç»æºæ‰‹èµ°è¿‡äº† ${document.getElementById('reportLoveDaysText').textContent} å¤©ï¼Œå…±åŒè®°å½•äº† ${document.getElementById('reportDiaryCountText').textContent} ç¯‡æ—¥è®°ï¼Œå†™ä¸‹äº† ${document.getElementById('reportWordCountText').textContent} å­—çš„ç¾å¥½å›å¿†ã€‚
            ä½ ä»¬ä¸€èµ·ç»å†äº† ${document.getElementById('reportMilestoneCountText').textContent} ä¸ªé‡è¦é‡Œç¨‹ç¢‘ï¼Œæ¯ä¸€ä¸ªç¬é—´éƒ½å€¼å¾—è¢«çè—ã€‚
            æ„¿ä½ ä»¬æ°¸è¿œç›¸çˆ±ï¼Œæºæ‰‹å¥”èµ´æ›´è¿œçš„æœªæ¥ï½â¤ï¸
            `.trim();

            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `çˆ±æƒ…æˆé•¿æŠ¥å‘Š_${state.coupleData.myNickname}_${new Date().toLocaleDateString()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // é»‘æš—æ¨¡å¼
        function toggleDarkMode() {
            const isDark = document.body.classList.toggle('dark-mode');
            state.coupleData.darkMode = isDark;
            saveCoupleData();
            document.getElementById('themeIcon').textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
            document.getElementById('themeText').textContent = isDark ? 'æµ…è‰²æ¨¡å¼'
